<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Smart Campus - Frontend</title>
  <style>
    :root{
      --bg:#0b1220;
      --card:#0f1b33;
      --card2:#0c1730;
      --txt:#e7eefc;
      --muted:#a9b7d6;
      --line:#1e2b4e;
      --accent:#7aa7ff;
      --accent2:#9bffcf;
      --danger:#ff6b6b;
      --warn:#ffd166;
      --ok:#4ade80;
      --shadow: 0 18px 50px rgba(0,0,0,.35);
      --radius: 18px;
      --radius2: 14px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background: radial-gradient(1200px 800px at 15% 10%, rgba(122,167,255,.15), transparent 55%),
                  radial-gradient(900px 600px at 85% 20%, rgba(155,255,207,.10), transparent 55%),
                  var(--bg);
      color:var(--txt);
      font-family:var(--font);
      min-height:100vh;
    }
    a{color:var(--accent); text-decoration:none}
    .wrap{max-width:1100px; margin:0 auto; padding:24px}
    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; margin-bottom:16px;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      padding:12px 14px; border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(15,27,51,.9), rgba(12,23,48,.85));
      border-radius:999px; box-shadow:var(--shadow);
    }
    .dot{width:10px; height:10px; border-radius:50%; background:var(--accent2); box-shadow:0 0 18px rgba(155,255,207,.45)}
    .brand b{letter-spacing:.3px}
    .pill{
      display:flex; align-items:center; gap:10px;
      border:1px solid var(--line);
      background:rgba(15,27,51,.65);
      border-radius:999px;
      padding:8px 10px;
    }
    .pill small{color:var(--muted)}
    .btn{
      border:1px solid var(--line);
      background:rgba(122,167,255,.12);
      color:var(--txt);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      transition:.15s transform, .15s opacity, .15s background;
      font-weight:600;
    }
    .btn:hover{transform:translateY(-1px); background:rgba(122,167,255,.18)}
    .btn:disabled{opacity:.55; cursor:not-allowed; transform:none}
    .btn.ghost{background:transparent}
    .btn.danger{background:rgba(255,107,107,.12)}
    .btn.danger:hover{background:rgba(255,107,107,.18)}
    .grid{display:grid; grid-template-columns: 1.2fr .8fr; gap:16px}
    @media (max-width: 940px){ .grid{grid-template-columns:1fr} }
    .card{
      border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(15,27,51,.88), rgba(12,23,48,.84));
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:16px 16px 12px;
      border-bottom:1px solid var(--line);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .card .hd h2{margin:0; font-size:16px}
    .card .bd{padding:16px}
    .muted{color:var(--muted)}
    .tabs{display:flex; gap:8px; flex-wrap:wrap}
    .tab{
      padding:10px 12px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(12,23,48,.55);
      cursor:pointer;
      font-weight:700;
      color:var(--muted);
      user-select:none;
    }
    .tab.active{
      color:var(--txt);
      background:rgba(122,167,255,.18);
      border-color:rgba(122,167,255,.4);
    }
    .row{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    @media (max-width:700px){ .row{grid-template-columns:1fr} }
    label{display:block; font-size:12px; color:var(--muted); margin:0 0 6px}
    input, select, textarea{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(11,18,32,.55);
      color:var(--txt);
      outline:none;
    }
    textarea{min-height:92px; resize:vertical}
    input:focus, select:focus, textarea:focus{border-color:rgba(122,167,255,.55); box-shadow:0 0 0 3px rgba(122,167,255,.10)}
    .actions{display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:12px}
    .note{
      padding:10px 12px;
      border-radius:14px;
      border:1px dashed rgba(169,183,214,.35);
      color:var(--muted);
      background:rgba(12,23,48,.35);
      font-size:12px;
      line-height:1.35;
    }
    .toast{
      position:fixed; right:18px; bottom:18px;
      display:flex; flex-direction:column; gap:10px;
      z-index:9999;
    }
    .toast .t{
      min-width:280px;
      max-width:380px;
      border:1px solid var(--line);
      background:rgba(15,27,51,.92);
      border-radius:16px;
      box-shadow:var(--shadow);
      padding:12px 12px;
      display:flex; gap:10px;
      align-items:flex-start;
      animation: pop .18s ease-out;
    }
    @keyframes pop{from{transform:translateY(8px); opacity:.5}to{transform:none; opacity:1}}
    .badge{
      font-size:11px;
      padding:5px 8px;
      border-radius:999px;
      border:1px solid rgba(169,183,214,.25);
      background:rgba(169,183,214,.08);
      color:var(--muted);
      font-weight:800;
      letter-spacing:.2px;
      white-space:nowrap;
    }
    .badge.ok{border-color:rgba(74,222,128,.28); background:rgba(74,222,128,.10); color:rgba(74,222,128,.95)}
    .badge.warn{border-color:rgba(255,209,102,.28); background:rgba(255,209,102,.10); color:rgba(255,209,102,.95)}
    .badge.danger{border-color:rgba(255,107,107,.28); background:rgba(255,107,107,.10); color:rgba(255,107,107,.95)}
    .kvs{display:grid; grid-template-columns: 120px 1fr; gap:8px 12px; font-size:12px; color:var(--muted)}
    .kvs b{color:var(--txt); font-weight:800}
    code.inline{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono"; font-size:12px; color:rgba(155,255,207,.95)}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <span class="dot"></span>
        <div>
          <b>Smart Campus</b>
          <div class="muted" style="font-size:12px">Frontend Demo (API-Linked)</div>
        </div>
      </div>

      <div class="pill">
        <small id="envTxt">API: …</small>
        <span id="authBadge" class="badge warn">GUEST</span>
        <button class="btn ghost" id="btnSwagger">Swagger</button>
        <button class="btn danger" id="btnLogout" style="display:none">Logout</button>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="hd">
          <h2 id="pageTitle">Login</h2>
          <div class="tabs" id="tabs"></div>
        </div>
        <div class="bd" id="page"></div>
      </div>

      <div class="card">
        <div class="hd">
          <h2>Runtime Info</h2>
          <span class="badge" id="roleBadge">ROLE: -</span>
        </div>
        <div class="bd">
          <div class="note" style="margin-bottom:12px">
            Edit the config at the top of the JS to match your Swagger.<br/>
            Token stored in <code class="inline">localStorage</code> as <code class="inline">Bearer</code>.
          </div>

          <div class="kvs">
            <div>Base URL</div><b id="kvBase">-</b>
            <div>Token</div><b id="kvToken">-</b>
            <div>User ID</div><b id="kvUserId">-</b>
            <div>Email</div><b id="kvEmail">-</b>
            <div>Role</div><b id="kvRole">-</b>
          </div>

          <div class="actions" style="margin-top:14px">
            <button class="btn" id="btnWhoAmI">WhoAmI</button>
            <button class="btn ghost" id="btnTestAuth">Refresh State</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
/* =========================
   1) CONFIG
   ========================= */
const API = {
  baseUrl: "https://just-presence-production-79e0.up.railway.app",
  swaggerUrl: "https://just-presence-production-79e0.up.railway.app/swagger-ui/index.html#/",

  endpoints: {
    login:       { method: "POST", path: "/api/auth/login" },
    register:    { method: "POST", path: "/api/auth/register" },
    whoami:      { method: "GET",  path: "/api/auth/me" }, // Changed from login to me
    addCourse:   { method: "POST", path: "/api/courses" },
    addCanteen:  { method: "POST", path: "/api/canteen/items" },
    addStudent:  { method: "POST", path: "/api/students" },
    addTeacher:  { method: "POST", path: "/api/teachers" },
  },

  payloadMaps: {
    login: (v) => ({ email: v.email, password: v.password }),
    register: (v) => ({ fullName: v.fullName, email: v.email, password: v.password, role: v.role }),
    addCourse: (v) => ({
      courseName: v.courseName,
      courseCode: v.courseCode,
      description: v.description,
      credits: String(v.credits),
      department: v.department,
      teacherId: Number(v.teacherId)
    }),
    addCanteen: (v) => ({
      name: v.itemName,
      price: Number(v.price),
      quantity: Number(v.quantity),
      category: v.category || null
    }),
    addStudent: (v) => ({
      fullName: v.fullName, email: v.email, password: v.password,
      level: v.level ? Number(v.level) : null,
      department: v.department || null
    }),
    addTeacher: (v) => ({
      fullName: v.fullName, email: v.email, password: v.password,
      department: v.department || null, title: v.title || null
    }),
  },
  validation: { passwordMin: 8 }
};

/* =========================
   2) STATE
   ========================= */
const store = {
  get token(){ return localStorage.getItem("sc_token") || ""; },
  set token(v){ v ? localStorage.setItem("sc_token", v) : localStorage.removeItem("sc_token"); },
  get user(){ try { return JSON.parse(localStorage.getItem("sc_user") || "null"); } catch { return null; } },
  set user(v){ v ? localStorage.setItem("sc_user", JSON.stringify(v)) : localStorage.removeItem("sc_user"); },
};

const state = { tab: "login", busy: false };

/* =========================
   3) HELPERS
   ========================= */
const $ = (sel) => document.querySelector(sel);

function toast(type, title, msg){
  const el = document.createElement("div");
  const badgeClass = type === "ok" ? "ok" : type === "warn" ? "warn" : "danger";
  el.className = "t";
  el.innerHTML = `
    <span class="badge ${badgeClass}">${type.toUpperCase()}</span>
    <div>
      <div style="font-weight:900; margin-bottom:2px">${escapeHtml(title)}</div>
      <div style="color:var(--muted); font-size:12px; line-height:1.35">${escapeHtml(msg)}</div>
    </div>
  `;
  $("#toast").appendChild(el);
  setTimeout(()=>{ el.style.opacity="0"; el.style.transform="translateY(8px)"; el.style.transition="200ms"; }, 3200);
  setTimeout(()=>{ el.remove(); }, 3600);
}

function escapeHtml(s){
  return String(s ?? "").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");
}

function isEmail(email){ return /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/i.test(String(email||"").trim()); }

function validatePassword(pw){
  if(String(pw||"").length < API.validation.passwordMin) return `Min ${API.validation.passwordMin} characters required.`;
  return "";
}

function decodeJwt(token){
  try{
    const payload = token.split(".")[1].replace(/-/g,'+').replace(/_/g,'/');
    return JSON.parse(atob(payload));
  }catch{ return null; }
}

function currentRole(){
  const u = store.user;
  if(u?.role) return u.role;
  const p = decodeJwt(store.token);
  return p?.role || p?.roles?.[0] || p?.authorities?.[0] || "-";
}

function setBusy(b){ state.busy = b; render(); }

/* =========================
   4) API CLIENT
   ========================= */
async function apiCall(key, body=null, extraOpts={}){
  const ep = API.endpoints[key];
  const url = API.baseUrl + ep.path;
  const headers = Object.assign({ "Accept":"application/json" }, (body ? { "Content-Type":"application/json" } : {}), extraOpts.headers || {});
  if(store.token) headers["Authorization"] = `Bearer ${store.token}`;

  const res = await fetch(url, { method: ep.method, headers, body: body ? JSON.stringify(body) : undefined });
  const text = await res.text();
  let data; try { data = JSON.parse(text); } catch { data = text; }

  if(!res.ok) throw new Error(typeof data === 'object' ? JSON.stringify(data) : data);
  return data;
}

/* =========================
   5) UI RENDER
   ========================= */
function render(){
  const isAuthed = !!store.token;
  const role = currentRole();
  const wrap = $("#tabs");
  wrap.innerHTML = "";
  
  const tabs = !isAuthed ? [{id:"login", label:"Login"}, {id:"register", label:"Register"}] : [{id:"admin", label:"Dashboard"}];
  if(isAuthed && state.tab !== "admin") state.tab = "admin";

  tabs.forEach(t => {
    const b = document.createElement("div");
    b.className = "tab" + (state.tab === t.id ? " active" : "");
    b.textContent = t.label;
    b.onclick = () => { state.tab = t.id; render(); };
    wrap.appendChild(b);
  });

  $("#pageTitle").textContent = state.tab.toUpperCase();
  $("#authBadge").textContent = isAuthed ? "AUTH" : "GUEST";
  $("#authBadge").className = "badge " + (isAuthed ? "ok" : "warn");
  $("#btnLogout").style.display = isAuthed ? "inline-block" : "none";
  $("#roleBadge").textContent = "ROLE: " + role;
  $("#envTxt").textContent = "API: " + API.baseUrl;
  $("#kvBase").textContent = API.baseUrl;
  $("#kvToken").textContent = store.token ? (store.token.slice(0,10) + "...") : "-";
  $("#kvEmail").textContent = store.user?.email || "-";
  $("#kvRole").textContent = role;

  const page = $("#page");
  page.innerHTML = "";
  if(state.tab === "login") page.appendChild(viewLogin());
  else if(state.tab === "register") page.appendChild(viewRegister());
  else page.appendChild(viewDashboard());
}

/* =========================
   6) VIEWS
   ========================= */
function viewLogin(){
  const root = document.createElement("div");
  root.innerHTML = `
    <div class="row">
      <div><label>Email</label><input id="loginEmail" placeholder="email@example.com" /></div>
      <div><label>Password</label><input id="loginPassword" type="password" placeholder="••••••••" /></div>
    </div>
    <div class="actions"><button class="btn" id="btnLogin">${state.busy ? "..." : "Login"}</button></div>
  `;
  root.querySelector("#btnLogin").onclick = async () => {
    setBusy(true);
    try {
      const payload = API.payloadMaps.login({email: $("#loginEmail").value, password: $("#loginPassword").value});
      const data = await apiCall("login", payload);
      store.token = data.token || data.accessToken || data.jwt;
      store.user = data.user || decodeJwt(store.token);
      toast("ok", "Success", "Logged in successfully");
      state.tab = "admin";
    } catch(e) { toast("danger", "Error", e.message); }
    finally { setBusy(false); }
  };
  return root;
}

function viewRegister(){
  const root = document.createElement("div");
  root.innerHTML = `
    <div class="row">
      <div><label>Full Name</label><input id="regName" /></div>
      <div><label>Role</label><select id="regRole"><option>STUDENT</option><option>TEACHER</option></select></div>
    </div>
    <div class="row" style="margin-top:12px">
      <div><label>Email</label><input id="regEmail" /></div>
      <div><label>Password</label><input id="regPassword" type="password" /></div>
    </div>
    <div class="actions"><button class="btn" id="btnReg">Register</button></div>
  `;
  root.querySelector("#btnReg").onclick = async () => {
    setBusy(true);
    try {
      const v = { fullName: $("#regName").value, email: $("#regEmail").value, password: $("#regPassword").value, role: $("#regRole").value };
      await apiCall("register", API.payloadMaps.register(v));
      toast("ok", "Success", "Account created");
      state.tab = "login";
    } catch(e) { toast("danger", "Error", e.message); }
    finally { setBusy(false); }
  };
  return root;
}

function viewDashboard(){
  const role = currentRole();
  const isAdmin = role === "ADMIN";
  const root = document.createElement("div");
  root.innerHTML = `
    <div class="card" style="margin-bottom:14px">
      <div class="hd"><h2>Add Course</h2></div>
      <div class="bd">
        <div class="row">
          <div><label>Course Name</label><input id="cName" /></div>
          <div><label>Course Code</label><input id="cCode" /></div>
        </div>
        <div class="row" style="margin-top:12px">
          <div><label>Credits</label><input id="cCredits" type="number" /></div>
          <div><label>Teacher ID</label><input id="cTeacherId" type="number" /></div>
        </div>
        <div class="row" style="margin-top:12px">
          <div><label>Department</label><input id="cDept" /></div>
          <div><label>Description</label><input id="cDesc" /></div>
        </div>
        <div class="actions"><button class="btn" id="btnAddCourse">Save Course</button></div>
      </div>
    </div>

    <div class="card" style="margin-bottom:14px">
      <div class="hd"><h2>Add Canteen Item</h2></div>
      <div class="bd">
        <div class="row">
          <div><label>Item Name</label><input id="iName" /></div>
          <div><label>Price</label><input id="iPrice" type="number" /></div>
        </div>
        <div class="actions"><button class="btn" id="btnAddItem">Save Item</button></div>
      </div>
    </div>
  `;

  root.querySelector("#btnAddCourse").onclick = async () => {
    setBusy(true);
    try {
      const v = { 
        courseName: $("#cName").value, courseCode: $("#cCode").value, 
        credits: $("#cCredits").value, teacherId: $("#cTeacherId").value,
        department: $("#cDept").value, description: $("#cDesc").value
      };
      await apiCall("addCourse", API.payloadMaps.addCourse(v));
      toast("ok", "Success", "Course added");
    } catch(e) { toast("danger", "Error", e.message); }
    finally { setBusy(false); }
  };

  root.querySelector("#btnAddItem").onclick = async () => {
    setBusy(true);
    try {
      const v = { itemName: $("#iName").value, price: $("#iPrice").value, quantity: 10 };
      await apiCall("addCanteen", API.payloadMaps.addCanteen(v));
      toast("ok", "Success", "Item added");
    } catch(e) { toast("danger", "Error", e.message); }
    finally { setBusy(false); }
  };

  return root;
}

/* =========================
   7) TOPBAR ACTIONS
   ========================= */
$("#btnSwagger").onclick = () => window.open(API.swaggerUrl, "_blank");
$("#btnLogout").onclick = () => { store.token = ""; store.user = null; state.tab = "login"; render(); };
$("#btnWhoAmI").onclick = async () => {
  if(!store.token) return toast("warn","Auth","Login first");
  setBusy(true);
  try {
    const data = await apiCall("whoami");
    store.user = data;
    toast("ok", "WhoAmI", "User data updated");
  } catch(e) { toast("danger", "Failed", e.message); }
  finally { setBusy(false); }
};

// Initial Render
render();
</script>
</body>
</html>







