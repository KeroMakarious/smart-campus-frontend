<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Smart Campus - Admin/Staff Frontend</title>
  <style>
    :root{
      --bg:#0b1220; --card:#0f1b33; --card2:#0c1730; --txt:#e7eefc; --muted:#a9b7d6;
      --line:#1e2b4e; --accent:#7aa7ff; --accent2:#9bffcf; --danger:#ff6b6b; --warn:#ffd166; --ok:#4ade80;
      --shadow:0 18px 50px rgba(0,0,0,.35); --radius:18px; --radius2:14px;
      --font: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
    }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family:var(--font); background:linear-gradient(180deg,#070c16,#0b1220 40%,#070c16); color:var(--txt); }
    a{ color:var(--accent); text-decoration:none; }
    .wrap{ max-width:1200px; margin:0 auto; padding:18px; }
    header{ display:flex; gap:14px; align-items:center; justify-content:space-between; margin-bottom:14px; }
    .brand{ display:flex; gap:10px; align-items:center; }
    .logo{ width:44px; height:44px; border-radius:14px; background:radial-gradient(circle at 30% 30%, var(--accent2), var(--accent)); box-shadow:var(--shadow); }
    h1{ font-size:18px; margin:0; }
    .sub{ color:var(--muted); font-size:12px; margin-top:2px; }
    .grid{ display:grid; grid-template-columns: 360px 1fr; gap:14px; }
    @media(max-width: 980px){ .grid{ grid-template-columns: 1fr; } }

    .card{ background:linear-gradient(180deg,var(--card), #0b162f); border:1px solid var(--line); border-radius:var(--radius); box-shadow:var(--shadow); }
    .card .hd{ padding:14px 14px 10px; border-bottom:1px solid var(--line); display:flex; justify-content:space-between; gap:10px; align-items:center; }
    .card .bd{ padding:14px; }
    .title{ font-size:14px; font-weight:700; }
    .pill{ font-size:11px; padding:6px 10px; border-radius:999px; border:1px solid var(--line); color:var(--muted); background:rgba(255,255,255,.02); }
    .row{ display:flex; gap:10px; }
    .row > *{ flex:1; }

    label{ display:block; font-size:12px; color:var(--muted); margin-bottom:6px; }
    input, select, textarea{
      width:100%; padding:11px 12px; border-radius:12px; border:1px solid var(--line);
      background:rgba(255,255,255,.03); color:var(--txt); outline:none;
    }
    textarea{ min-height:92px; resize:vertical; }
    input::placeholder, textarea::placeholder{ color:#7f8fb6; }
    .btn{
      appearance:none; border:1px solid var(--line); background:rgba(122,167,255,.14);
      color:var(--txt); padding:10px 12px; border-radius:12px; cursor:pointer;
      transition:.12s transform ease, .12s opacity ease;
      font-weight:650;
    }
    .btn:hover{ transform:translateY(-1px); }
    .btn:disabled{ opacity:.5; cursor:not-allowed; transform:none; }
    .btn.primary{ background:linear-gradient(90deg, rgba(122,167,255,.20), rgba(155,255,207,.12)); border-color:rgba(122,167,255,.35); }
    .btn.danger{ background:rgba(255,107,107,.12); border-color:rgba(255,107,107,.35); }
    .btn.ghost{ background:transparent; }
    .btn.small{ padding:7px 10px; font-size:12px; border-radius:10px; }

    .tabs{ display:flex; gap:8px; flex-wrap:wrap; }
    .tab{ padding:8px 10px; border-radius:999px; border:1px solid var(--line); cursor:pointer; color:var(--muted); background:rgba(255,255,255,.02); font-size:12px; }
    .tab.active{ color:var(--txt); border-color:rgba(122,167,255,.4); background:rgba(122,167,255,.12); }

    .list{ display:grid; gap:10px; }
    .item{
      border:1px solid var(--line); border-radius:14px; background:rgba(255,255,255,.02);
      padding:12px;
      display:flex; justify-content:space-between; gap:10px; align-items:flex-start;
    }
    .item .meta{ display:grid; gap:4px; }
    .item .meta .k{ font-weight:700; font-size:13px; }
    .item .meta .v{ color:var(--muted); font-size:12px; word-break:break-word; }
    .actions{ display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; }
    .hr{ height:1px; background:var(--line); margin:12px 0; }
    .toast-wrap{ position:fixed; left:16px; bottom:16px; display:grid; gap:10px; z-index:9999; max-width: 420px; }
    .toast{
      border:1px solid var(--line); border-radius:14px; padding:12px; background:rgba(12,23,48,.95); box-shadow:var(--shadow);
    }
    .toast .t{ font-weight:800; margin-bottom:4px; }
    .toast .m{ color:var(--muted); font-size:12px; line-height:1.45; }
    .toast.ok{ border-color:rgba(74,222,128,.4); }
    .toast.warn{ border-color:rgba(255,209,102,.45); }
    .toast.err{ border-color:rgba(255,107,107,.45); }

    .badge{ display:inline-flex; align-items:center; gap:6px; font-size:11px; color:var(--muted); }
    .dot{ width:8px; height:8px; border-radius:50%; background:var(--warn); }
    .dot.ok{ background:var(--ok); }
    .dot.err{ background:var(--danger); }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size:12px; color:var(--muted); }
    .hint{ color:var(--muted); font-size:12px; line-height:1.5; }
    .kpi{ display:grid; grid-template-columns:repeat(3,1fr); gap:10px; }
    @media(max-width: 520px){ .kpi{ grid-template-columns:1fr; } }
    .kpi .box{ border:1px solid var(--line); border-radius:14px; padding:12px; background:rgba(255,255,255,.02); }
    .kpi .box .n{ font-size:18px; font-weight:900; }
    .kpi .box .l{ color:var(--muted); font-size:12px; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>Smart Campus Frontend</h1>
          <div class="sub">Login/Register + Courses + Canteen + Admin Users (Students/Teachers)</div>
        </div>
      </div>
      <div class="badge" id="apiStatus">
        <span class="dot" id="apiDot"></span>
        <span id="apiText">API: checking…</span>
      </div>
    </header>

    <div class="grid">
      <!-- LEFT: AUTH + SETTINGS -->
      <div class="card">
        <div class="hd">
          <div class="title">الحساب</div>
          <div class="pill" id="rolePill">Role: -</div>
        </div>
        <div class="bd">
          <div class="tabs" id="authTabs">
            <div class="tab active" data-tab="login">Login</div>
            <div class="tab" data-tab="register">Register</div>
          </div>

          <div id="loginPane" style="margin-top:12px;">
            <label>Email</label>
            <input id="loginEmail" placeholder="name@example.com" autocomplete="username" />
            <div style="height:10px"></div>
            <label>Password</label>
            <input id="loginPassword" type="password" placeholder="Your password" autocomplete="current-password" />
            <div style="height:12px"></div>
            <button class="btn primary" id="btnLogin">Login</button>
          </div>

          <div id="registerPane" style="display:none; margin-top:12px;">
            <div class="row">
              <div>
                <label>Full name</label>
                <input id="regName" placeholder="Your name" autocomplete="name" />
              </div>
              <div>
                <label>Role</label>
                <select id="regRole">
                  <option value="STUDENT">STUDENT</option>
                  <option value="TEACHER">TEACHER</option>
                </select>
              </div>
            </div>
            <div style="height:10px"></div>
            <label>Email</label>
            <input id="regEmail" placeholder="name@example.com" autocomplete="email" />
            <div style="height:10px"></div>
            <label>Password</label>
            <input id="regPassword" type="password" placeholder="Min 8, فيها حرف و رقم (لو الباك إند بيطلب كده)" autocomplete="new-password" />
            <div style="height:12px"></div>
            <button class="btn primary" id="btnRegister">Register</button>
          </div>

          <div class="hr"></div>

          <div class="kpi">
            <div class="box">
              <div class="n" id="kpiUser">-</div>
              <div class="l">User</div>
            </div>
            <div class="box">
              <div class="n" id="kpiToken">-</div>
              <div class="l">Token</div>
            </div>
            <div class="box">
              <div class="n" id="kpiApi">-</div>
              <div class="l">API</div>
            </div>
          </div>

          <div class="hr"></div>

          <div class="row">
            <button class="btn ghost" id="btnWhoAmI">WhoAmI</button>
            <button class="btn danger" id="btnLogout">Logout</button>
          </div>

          <div class="hr"></div>

          <div class="title" style="margin-bottom:8px;">إعدادات الربط</div>
          <div class="hint">
            Base API ثابت على Railway. اكتشاف OpenAPI تلقائي. لو فشل، بيستخدم Fallback Routes تحت.
          </div>
          <div style="height:10px"></div>

          <label>Base API</label>
          <input id="baseUrl" class="mono" />
          <div style="height:10px"></div>
          <label>Detected OpenAPI URL</label>
          <input id="openapiUrl" class="mono" disabled />
          <div style="height:12px"></div>
          <button class="btn small" id="btnReDetect">Re-detect API</button>
        </div>
      </div>

      <!-- RIGHT: MODULES -->
      <div class="card">
        <div class="hd">
          <div class="title">الإدارة</div>
          <div class="tabs" id="mainTabs">
            <div class="tab active" data-tab="courses">Courses</div>
            <div class="tab" data-tab="canteen">Canteen</div>
            <div class="tab" data-tab="admin">Admin Users</div>
            <div class="tab" data-tab="raw">Raw API</div>
          </div>
        </div>
        <div class="bd">
          <!-- COURSES -->
          <div class="pane" id="paneCourses">
            <div class="row">
              <button class="btn primary" id="btnLoadCourses">Load Courses</button>
              <button class="btn" id="btnNewCourse">New Course</button>
            </div>
            <div id="courseForm" style="display:none; margin-top:12px;">
              <div class="row">
                <div>
                  <label>Course name</label>
                  <input id="courseName" placeholder="مثال: Math 101" />
                </div>
                <div>
                  <label>Course code</label>
                  <input id="courseCode" placeholder="مثال: MTH101" />
                </div>
              </div>
              <div style="height:10px"></div>
              <div class="row">
                <div>
                  <label>Teacher Id (اختياري حسب الباك)</label>
                  <input id="courseTeacherId" placeholder="مثال: 12" />
                </div>
                <div>
                  <label>Credits / Price (اختياري)</label>
                  <input id="courseMeta" placeholder="رقم" />
                </div>
              </div>
              <div style="height:10px"></div>
              <label>Description (اختياري)</label>
              <textarea id="courseDesc" placeholder="وصف مختصر"></textarea>
              <div style="height:10px"></div>
              <div class="row">
                <button class="btn primary" id="btnSaveCourse">Save</button>
                <button class="btn ghost" id="btnCancelCourse">Cancel</button>
              </div>
              <div class="hint" style="margin-top:10px;">
                الفورم بيبني JSON مرن. لو الباك إند طالب أسماء حقول مختلفة، هتتضبط تلقائيًا لو OpenAPI اتكشف.
              </div>
            </div>

            <div class="hr"></div>
            <div class="list" id="coursesList"></div>
          </div>

          <!-- CANTEEN -->
          <div class="pane" id="paneCanteen" style="display:none;">
            <div class="row">
              <button class="btn primary" id="btnLoadCanteen">Load Items</button>
              <button class="btn" id="btnNewItem">New Item</button>
            </div>
            <div id="itemForm" style="display:none; margin-top:12px;">
              <div class="row">
                <div>
                  <label>Item name</label>
                  <input id="itemName" placeholder="مثال: Sandwich" />
                </div>
                <div>
                  <label>Price</label>
                  <input id="itemPrice" placeholder="مثال: 25" />
                </div>
              </div>
              <div style="height:10px"></div>
              <div class="row">
                <div>
                  <label>Quantity / Stock (اختياري)</label>
                  <input id="itemQty" placeholder="مثال: 100" />
                </div>
                <div>
                  <label>Category (اختياري)</label>
                  <input id="itemCat" placeholder="مثال: Drinks" />
                </div>
              </div>
              <div style="height:10px"></div>
              <label>Description (اختياري)</label>
              <textarea id="itemDesc" placeholder="وصف مختصر"></textarea>
              <div style="height:10px"></div>
              <div class="row">
                <button class="btn primary" id="btnSaveItem">Save</button>
                <button class="btn ghost" id="btnCancelItem">Cancel</button>
              </div>
            </div>

            <div class="hr"></div>
            <div class="list" id="canteenList"></div>
          </div>

          <!-- ADMIN USERS -->
          <div class="pane" id="paneAdmin" style="display:none;">
            <div class="hint">
              إضافة Student/Teacher مسموحة لو Role = ADMIN. الفرونت هيمنع الزرار لو مش Admin.
            </div>
            <div style="height:10px"></div>

            <div class="row">
              <button class="btn primary" id="btnLoadUsers">Load Users</button>
              <button class="btn" id="btnNewStudent">New Student</button>
              <button class="btn" id="btnNewTeacher">New Teacher</button>
            </div>

            <div id="userForm" style="display:none; margin-top:12px;">
              <div class="row">
                <div>
                  <label>Full name</label>
                  <input id="userName" placeholder="Name" />
                </div>
                <div>
                  <label>Type</label>
                  <select id="userType">
                    <option value="STUDENT">STUDENT</option>
                    <option value="TEACHER">TEACHER</option>
                  </select>
                </div>
              </div>
              <div style="height:10px"></div>
              <div class="row">
                <div>
                  <label>Email</label>
                  <input id="userEmail" placeholder="name@example.com" />
                </div>
                <div>
                  <label>Password</label>
                  <input id="userPassword" type="password" placeholder="Min 8" />
                </div>
              </div>
              <div style="height:10px"></div>
              <div class="row">
                <div>
                  <label>StudentId / StaffId (اختياري)</label>
                  <input id="userExternalId" placeholder="مثال: 2025001" />
                </div>
                <div>
                  <label>Department (اختياري)</label>
                  <input id="userDept" placeholder="CS / Math" />
                </div>
              </div>
              <div style="height:10px"></div>
              <div class="row">
                <button class="btn primary" id="btnSaveUser">Save</button>
                <button class="btn ghost" id="btnCancelUser">Cancel</button>
              </div>
            </div>

            <div class="hr"></div>
            <div class="list" id="usersList"></div>
          </div>

          <!-- RAW API -->
          <div class="pane" id="paneRaw" style="display:none;">
            <div class="hint">
              ده لاختبار أي Endpoint بسرعة. بيحط Authorization تلقائي لو فيه Token.
            </div>
            <div style="height:10px"></div>
            <div class="row">
              <div>
                <label>Method</label>
                <select id="rawMethod">
                  <option>GET</option><option>POST</option><option>PUT</option><option>PATCH</option><option>DELETE</option>
                </select>
              </div>
              <div style="flex:3;">
                <label>Path</label>
                <input id="rawPath" placeholder="/api/..." class="mono" />
              </div>
            </div>
            <div style="height:10px"></div>
            <label>Body JSON (لو POST/PUT/PATCH)</label>
            <textarea id="rawBody" class="mono" placeholder='{"name":"..."}'></textarea>
            <div style="height:10px"></div>
            <button class="btn primary" id="btnSendRaw">Send</button>
            <div class="hr"></div>
            <label>Response</label>
            <textarea id="rawResp" class="mono" style="min-height:220px;" readonly></textarea>
          </div>

        </div>
      </div>
    </div>
  </div>

  <div class="toast-wrap" id="toasts"></div>

<script>
/* =========================
   CONFIG
   ========================= */
const store = {
  baseUrl: "https://just-presence-production-79e0.up.railway.app",
  token: localStorage.getItem("jp_token") || "",
  user: JSON.parse(localStorage.getItem("jp_user") || "null"),
  openapi: null,
  openapiUrl: "",
  routes: null,
  busy: false,
  editing: {
    course: null,
    item: null,
    user: null
  }
};

/* Fallback routes. بتشتغل لو OpenAPI مش متاح.
   لو عندك paths مختلفة، عدّل هنا فقط. */
const FALLBACK = {
  auth: {
    login:  { method:"POST", path:"/api/auth/login" },
    register:{ method:"POST", path:"/api/auth/register" },
    me:     { method:"GET",  path:"/api/auth/me" }, // أو /api/users/{id}
  },
  courses: {
    list:   { method:"GET",  path:"/api/courses" },
    create: { method:"POST", path:"/api/courses" },
    update: { method:"PUT",  path:"/api/courses/{id}" },
    delete: { method:"DELETE", path:"/api/courses/{id}" }
  },
  canteen: {
    list:   { method:"GET",  path:"/api/canteen/items" },
    create: { method:"POST", path:"/api/canteen/items" },
    update: { method:"PUT",  path:"/api/canteen/items/{id}" },
    delete: { method:"DELETE", path:"/api/canteen/items/{id}" }
  },
  users: {
    list:   { method:"GET",  path:"/api/users" },
    createStudent:{ method:"POST", path:"/api/admin/students" },
    createTeacher:{ method:"POST", path:"/api/admin/teachers" },
    update: { method:"PUT",  path:"/api/users/{id}" },
    delete: { method:"DELETE", path:"/api/users/{id}" }
  }
};

/* =========================
   UTIL
   ========================= */
const $ = (s)=>document.querySelector(s);
const el = (tag, cls)=>{ const x=document.createElement(tag); if(cls) x.className=cls; return x; };
const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));

function toast(type, title, msg){
  const w = $("#toasts");
  const t = el("div", "toast " + (type||""));
  const tt = el("div","t"); tt.textContent = title||"";
  const mm = el("div","m"); mm.textContent = msg||"";
  t.appendChild(tt); t.appendChild(mm);
  w.appendChild(t);
  setTimeout(()=>{ t.style.opacity="0"; t.style.transform="translateY(6px)"; }, 3200);
  setTimeout(()=>{ t.remove(); }, 3800);
}

function setBusy(v){
  store.busy = v;
  ["#btnLogin","#btnRegister","#btnWhoAmI","#btnLogout","#btnLoadCourses","#btnSaveCourse","#btnLoadCanteen","#btnSaveItem","#btnLoadUsers","#btnSaveUser","#btnSendRaw","#btnReDetect"]
    .forEach(id=>{ const b=$(id); if(b) b.disabled = !!v; });
}

function setStatus(ok, text){
  $("#apiText").textContent = text;
  const d = $("#apiDot");
  d.classList.remove("ok","err");
  d.classList.add(ok ? "ok" : "err");
}

function saveSession(){
  localStorage.setItem("jp_token", store.token||"");
  localStorage.setItem("jp_user", JSON.stringify(store.user||null));
  $("#kpiToken").textContent = store.token ? "YES" : "NO";
  $("#kpiUser").textContent = store.user ? (store.user.email || store.user.username || store.user.name || "OK") : "-";
  const role = getRole();
  $("#rolePill").textContent = "Role: " + (role||"-");
}

function getRole(){
  const u = store.user;
  if(!u) return "";
  return u.role || u.userRole || u.type || u.authorities?.[0] || "";
}

function isAdmin(){
  const r = (getRole()||"").toUpperCase();
  return r.includes("ADMIN");
}

function normalizeBaseUrl(u){
  u = (u||"").trim().replace(/\/+$/,"");
  if(!u) return store.baseUrl;
  return u;
}

function safeJsonParse(s){
  try{ return JSON.parse(s); }catch{ return null; }
}

function pickId(obj){
  if(!obj) return null;
  return obj.id ?? obj.userId ?? obj.courseId ?? obj.itemId ?? obj._id ?? null;
}

function buildPath(path, params){
  let p = path;
  if(params){
    for(const k of Object.keys(params)){
      p = p.replaceAll("{"+k+"}", encodeURIComponent(params[k]));
    }
  }
  return p;
}

/* =========================
   API CALL CORE
   ========================= */
async function request({method, path, body, pathParams, queryParams}){
  const base = normalizeBaseUrl($("#baseUrl").value || store.baseUrl);
  store.baseUrl = base;

  let url = base + buildPath(path, pathParams);

  if(queryParams){
    const qs = new URLSearchParams();
    Object.entries(queryParams).forEach(([k,v])=>{
      if(v===undefined || v===null || v==="") return;
      qs.set(k, v);
    });
    const q = qs.toString();
    if(q) url += (url.includes("?") ? "&" : "?") + q;
  }

  const headers = { "Content-Type":"application/json" };
  if(store.token) headers["Authorization"] = "Bearer " + store.token;

  const opts = { method, headers };
  if(body !== undefined && body !== null && method !== "GET" && method !== "DELETE"){
    opts.body = JSON.stringify(body);
  }

  let res, text;
  try{
    res = await fetch(url, opts);
    text = await res.text();
  }catch(e){
    throw new Error("Network error: " + (e?.message || e));
  }

  let data = safeJsonParse(text);
  if(!res.ok){
    const msg = (data && (data.message || data.error || data.details)) ? (data.message||data.error||data.details) : text;
    const err = new Error(`HTTP ${res.status}: ${msg}`);
    err.status = res.status;
    err.payload = data || text;
    throw err;
  }

  return data ?? text;
}

/* =========================
   OPENAPI AUTO-DETECT + ROUTE RESOLVE
   ========================= */
async function detectOpenApi(){
  const base = normalizeBaseUrl($("#baseUrl").value || store.baseUrl);

  const candidates = [
    base + "/v3/api-docs",
    base + "/v3/api-docs/swagger-config",
    base + "/api-docs",
    base + "/swagger/v1/swagger.json",
    base + "/swagger.json",
    base + "/openapi.json",
    base + "/v2/api-docs"
  ];

  store.openapi = null;
  store.openapiUrl = "";
  $("#openapiUrl").value = "";

  for(const url of candidates){
    try{
      const res = await fetch(url, { method:"GET" });
      if(!res.ok) continue;
      const text = await res.text();
      const js = safeJsonParse(text);
      if(!js) continue;

      // swagger-config sometimes contains url field
      if(js.url && typeof js.url === "string"){
        const full = js.url.startsWith("http") ? js.url : (base + js.url);
        const r2 = await fetch(full, { method:"GET" });
        if(r2.ok){
          const specText = await r2.text();
          const spec = safeJsonParse(specText);
          if(spec && (spec.paths || spec.openapi || spec.swagger)){
            store.openapi = spec;
            store.openapiUrl = full;
            $("#openapiUrl").value = full;
            return true;
          }
        }
      }

      if(js && (js.paths || js.openapi || js.swagger)){
        store.openapi = js;
        store.openapiUrl = url;
        $("#openapiUrl").value = url;
        return true;
      }
    }catch(_e){ /* ignore */ }
  }
  return false;
}

function buildRoutesFromOpenApi(spec){
  // هدفنا: نطلع endpoints الأساسية: auth login/register/me + courses CRUD + canteen CRUD + users + admin create student/teacher
  const paths = spec.paths || {};
  const ops = [];
  for(const [p, methods] of Object.entries(paths)){
    for(const [m, op] of Object.entries(methods || {})){
      const mm = (m||"").toUpperCase();
      if(!["GET","POST","PUT","PATCH","DELETE"].includes(mm)) continue;
      const tag = (op.tags && op.tags[0]) ? op.tags[0] : "";
      const sum = op.summary || op.operationId || "";
      ops.push({ method:mm, path:p, tag, sum, op });
    }
  }

  const pick = (preds)=>{
    for(const pred of preds){
      const hit = ops.find(o=>pred(o));
      if(hit) return { method:hit.method, path:hit.path };
    }
    return null;
  };

  const r = JSON.parse(JSON.stringify(FALLBACK));

  // AUTH
  r.auth.login = pick([
    o=>/auth/i.test(o.tag) && /login/i.test(o.sum) && o.method==="POST",
    o=>/\/auth\/login$/i.test(o.path) && o.method==="POST",
    o=>/\/login$/i.test(o.path) && o.method==="POST"
  ]) || r.auth.login;

  r.auth.register = pick([
    o=>/auth/i.test(o.tag) && /(register|signup)/i.test(o.sum) && o.method==="POST",
    o=>/\/auth\/register$/i.test(o.path) && o.method==="POST",
    o=>/(register|signup)$/i.test(o.path) && o.method==="POST"
  ]) || r.auth.register;

  r.auth.me = pick([
    o=>/auth/i.test(o.tag) && /(me|whoami|profile)/i.test(o.sum) && o.method==="GET",
    o=>/\/auth\/me$/i.test(o.path) && o.method==="GET",
    o=>/\/users\/\{id\}$/i.test(o.path) && o.method==="GET",
    o=>/\/users\/me$/i.test(o.path) && o.method==="GET",
  ]) || r.auth.me;

  // COURSES
  r.courses.list = pick([
    o=>/course/i.test(o.tag) && o.method==="GET" && !/\{id\}/.test(o.path),
    o=>/\/courses$/i.test(o.path) && o.method==="GET"
  ]) || r.courses.list;

  r.courses.create = pick([
    o=>/course/i.test(o.tag) && o.method==="POST",
    o=>/\/courses$/i.test(o.path) && o.method==="POST"
  ]) || r.courses.create;

  r.courses.update = pick([
    o=>/course/i.test(o.tag) && (o.method==="PUT"||o.method==="PATCH") && /\{id\}/.test(o.path),
    o=>/\/courses\/\{id\}$/i.test(o.path) && (o.method==="PUT"||o.method==="PATCH")
  ]) || r.courses.update;

  r.courses.delete = pick([
    o=>/course/i.test(o.tag) && o.method==="DELETE" && /\{id\}/.test(o.path),
    o=>/\/courses\/\{id\}$/i.test(o.path) && o.method==="DELETE"
  ]) || r.courses.delete;

  // CANTEEN
  r.canteen.list = pick([
    o=>/canteen|item|food/i.test(o.tag) && o.method==="GET" && !/\{id\}/.test(o.path),
    o=>/\/canteen\/items$/i.test(o.path) && o.method==="GET",
    o=>/\/items$/i.test(o.path) && o.method==="GET"
  ]) || r.canteen.list;

  r.canteen.create = pick([
    o=>/canteen|item|food/i.test(o.tag) && o.method==="POST",
    o=>/\/canteen\/items$/i.test(o.path) && o.method==="POST",
    o=>/\/items$/i.test(o.path) && o.method==="POST"
  ]) || r.canteen.create;

  r.canteen.update = pick([
    o=>/canteen|item|food/i.test(o.tag) && (o.method==="PUT"||o.method==="PATCH") && /\{id\}/.test(o.path),
    o=>/\/canteen\/items\/\{id\}$/i.test(o.path) && (o.method==="PUT"||o.method==="PATCH"),
    o=>/\/items\/\{id\}$/i.test(o.path) && (o.method==="PUT"||o.method==="PATCH"),
  ]) || r.canteen.update;

  r.canteen.delete = pick([
    o=>/canteen|item|food/i.test(o.tag) && o.method==="DELETE" && /\{id\}/.test(o.path),
    o=>/\/canteen\/items\/\{id\}$/i.test(o.path) && o.method==="DELETE",
    o=>/\/items\/\{id\}$/i.test(o.path) && o.method==="DELETE",
  ]) || r.canteen.delete;

  // USERS
  r.users.list = pick([
    o=>/user/i.test(o.tag) && o.method==="GET" && !/\{id\}/.test(o.path),
    o=>/\/users$/i.test(o.path) && o.method==="GET"
  ]) || r.users.list;

  r.users.update = pick([
    o=>/user/i.test(o.tag) && (o.method==="PUT"||o.method==="PATCH") && /\{id\}/.test(o.path),
    o=>/\/users\/\{id\}$/i.test(o.path) && (o.method==="PUT"||o.method==="PATCH")
  ]) || r.users.update;

  r.users.delete = pick([
    o=>/user/i.test(o.tag) && o.method==="DELETE" && /\{id\}/.test(o.path),
    o=>/\/users\/\{id\}$/i.test(o.path) && o.method==="DELETE"
  ]) || r.users.delete;

  r.users.createStudent = pick([
    o=>(/admin/i.test(o.tag) || /student/i.test(o.tag)) && o.method==="POST" && /student/i.test(o.path),
    o=>/\/admin\/students$/i.test(o.path) && o.method==="POST",
  ]) || r.users.createStudent;

  r.users.createTeacher = pick([
    o=>(/admin/i.test(o.tag) || /teacher/i.test(o.tag)) && o.method==="POST" && /teacher/i.test(o.path),
    o=>/\/admin\/teachers$/i.test(o.path) && o.method==="POST",
  ]) || r.users.createTeacher;

  return r;
}

/* =========================
   AUTH
   ========================= */
function validateEmail(e){
  return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test((e||"").trim());
}
function validatePassword(p){
  // سياسة مرنة: أقل حاجة 8. لو الباك إند عايز أقوى، هيطلع message ونظهره.
  p = (p||"");
  return p.length >= 8;
}

async function login(){
  const email = $("#loginEmail").value.trim();
  const password = $("#loginPassword").value;

  if(!validateEmail(email)) return toast("warn","Email غلط","اكتب Email صحيح");
  if(!password) return toast("warn","Password ناقص","اكتب Password");

  setBusy(true);
  try{
    const r = store.routes.auth.login;
    const data = await request({ method:r.method, path:r.path, body:{ email, password } });

    // توكن ممكن يرجع: token / accessToken / jwt
    const token = data?.token || data?.accessToken || data?.jwt || data?.data?.token || "";
    if(!token) throw new Error("Token مش راجع من الباك إند");

    store.token = token;

    // user ممكن يرجع في نفس الريسبونس
    store.user = data?.user || data?.data?.user || null;
    if(!store.user){
      // حاول me
      await whoami(true);
    }else{
      saveSession();
    }

    toast("ok","تم تسجيل الدخول","Login OK");
    await pingApi();
  }catch(e){
    toast("err","Login فشل", e.message || String(e));
  }finally{
    setBusy(false);
  }
}

async function register(){
  const name = $("#regName").value.trim();
  const role = $("#regRole").value;
  const email = $("#regEmail").value.trim();
  const password = $("#regPassword").value;

  if(!name) return toast("warn","Name ناقص","اكتب الاسم");
  if(!validateEmail(email)) return toast("warn","Email غلط","اكتب Email صحيح");
  if(!validatePassword(password)) return toast("warn","Password ضعيف","على الأقل 8 حروف");

  setBusy(true);
  try{
    const r = store.routes.auth.register;

    // جسم مرن. الباك إند ممكن يبقى name/fullName/username + role/type
    const body = { name, fullName:name, username:name, email, password, role, type:role };

    const data = await request({ method:r.method, path:r.path, body });

    // بعض الباكات بتعمل register وترجع token
    const token = data?.token || data?.accessToken || data?.jwt || data?.data?.token || "";
    if(token){
      store.token = token;
      store.user = data?.user || data?.data?.user || null;
      if(!store.user) await whoami(true);
      saveSession();
      toast("ok","Register OK","الحساب اتعمل واتسجلت دخول");
    }else{
      toast("ok","Register OK","الحساب اتعمل. اعمل Login");
      // نقل للوجين
      switchAuthTab("login");
      $("#loginEmail").value = email;
      $("#loginPassword").value = password;
    }

    await pingApi();
  }catch(e){
    toast("err","Register فشل", e.message || String(e));
  }finally{
    setBusy(false);
  }
}

async function whoami(silent){
  if(!store.token){
    if(!silent) toast("warn","مش مسجل دخول","Login الأول");
    return null;
  }
  setBusy(true);
  try{
    const r = store.routes.auth.me;

    // لو endpoint هو /api/users/{id} لازم id
    let pathParams = undefined;
    if(/\{id\}/.test(r.path)){
      const id = store.user?.id || store.user?.userId;
      if(!id) throw new Error("User ID not found");
      pathParams = { id };
    }

    const data = await request({ method:r.method, path:r.path, pathParams });

    store.user = data?.user || data?.data?.user || data;
    saveSession();

    // تحديث صلاحيات admin buttons
    syncAdminButtons();

    if(!silent) toast("ok","WhoAmI OK","تم تحديث بيانات الحساب");
    return store.user;
  }catch(e){
    if(!silent) toast("err","WhoAmI فشل", e.message || String(e));
    return null;
  }finally{
    setBusy(false);
  }
}

function logout(){
  store.token = "";
  store.user = null;
  saveSession();
  syncAdminButtons();
  toast("ok","Logout","تم تسجيل الخروج");
}

/* =========================
   MODULES: COURSES
   ========================= */
function showCourseForm(editObj){
  store.editing.course = editObj || null;
  $("#courseForm").style.display = "block";
  $("#courseName").value = editObj?.name || editObj?.courseName || "";
  $("#courseCode").value = editObj?.code || editObj?.courseCode || "";
  $("#courseTeacherId").value = editObj?.teacherId || editObj?.teacher?.id || "";
  $("#courseMeta").value = editObj?.credits || editObj?.price || editObj?.meta || "";
  $("#courseDesc").value = editObj?.description || editObj?.desc || "";
}
function hideCourseForm(){
  store.editing.course = null;
  $("#courseForm").style.display = "none";
}
async function loadCourses(){
  setBusy(true);
  try{
    const r = store.routes.courses.list;
    const data = await request({ method:r.method, path:r.path });

    const arr = Array.isArray(data) ? data : (data?.content || data?.data || data?.items || []);
    renderCourses(arr);
    toast("ok","Courses","تم تحميل الكورسات");
  }catch(e){
    toast("err","Courses فشل", e.message || String(e));
  }finally{
    setBusy(false);
  }
}
function renderCourses(list){
  const root = $("#coursesList");
  root.innerHTML = "";
  if(!list || !list.length){
    const empty = el("div","hint");
    empty.textContent = "مفيش Courses.";
    root.appendChild(empty);
    return;
  }

  list.forEach(c=>{
    const it = el("div","item");
    const meta = el("div","meta");
    const k = el("div","k"); k.textContent = (c.name || c.courseName || "Course") + (c.code || c.courseCode ? " • " + (c.code || c.courseCode) : "");
    const v = el("div","v"); v.textContent = "id: " + (pickId(c) ?? "-") + (c.description ? " | " + c.description : "");
    meta.appendChild(k); meta.appendChild(v);

    const act = el("div","actions");
    const bEdit = el("button","btn small"); bEdit.textContent="Edit";
    bEdit.onclick = ()=>showCourseForm(c);

    const bDel = el("button","btn small danger"); bDel.textContent="Delete";
    bDel.onclick = ()=>deleteCourse(c);

    act.appendChild(bEdit); act.appendChild(bDel);

    it.appendChild(meta); it.appendChild(act);
    root.appendChild(it);
  });
}
async function saveCourse(){
  const name = $("#courseName").value.trim();
  const code = $("#courseCode").value.trim();
  const teacherId = $("#courseTeacherId").value.trim();
  const meta = $("#courseMeta").value.trim();
  const desc = $("#courseDesc").value.trim();

  if(!name) return toast("warn","Course","Name مطلوب");

  setBusy(true);
  try{
    const editing = store.editing.course;
    const id = editing ? pickId(editing) : null;

    const body = {
      name, courseName:name,
      code, courseCode:code,
      description: desc, desc,
    };

    if(teacherId) body.teacherId = Number(teacherId) || teacherId;
    if(meta) body.credits = Number(meta) || meta;

    let r;
    if(id){
      r = store.routes.courses.update;
      await request({ method:r.method, path:r.path, pathParams:{ id }, body });
      toast("ok","Course Updated","تم التعديل");
    }else{
      r = store.routes.courses.create;
      await request({ method:r.method, path:r.path, body });
      toast("ok","Course Created","تم الإضافة");
    }

    hideCourseForm();
    await loadCourses();
  }catch(e){
    toast("err","Save Course فشل", e.message || String(e));
  }finally{
    setBusy(false);
  }
}
async function deleteCourse(c){
  const id = pickId(c);
  if(id === null || id === undefined) return toast("warn","Delete","id مش موجود في العنصر");

  setBusy(true);
  try{
    const r = store.routes.courses.delete;
    await request({ method:r.method, path:r.path, pathParams:{ id } });
    toast("ok","Deleted","تم الحذف");
    await loadCourses();
  }catch(e){
    toast("err","Delete فشل", e.message || String(e));
  }finally{
    setBusy(false);
  }
}

/* =========================
   MODULES: CANTEEN
   ========================= */
function showItemForm(editObj){
  store.editing.item = editObj || null;
  $("#itemForm").style.display = "block";
  $("#itemName").value = editObj?.name || editObj?.itemName || "";
  $("#itemPrice").value = editObj?.price || editObj?.cost || "";
  $("#itemQty").value = editObj?.quantity || editObj?.stock || "";
  $("#itemCat").value = editObj?.category || editObj?.type || "";
  $("#itemDesc").value = editObj?.description || editObj?.desc || "";
}
function hideItemForm(){
  store.editing.item = null;
  $("#itemForm").style.display = "none";
}
async function loadCanteen(){
  setBusy(true);
  try{
    const r = store.routes.canteen.list;
    const data = await request({ method:r.method, path:r.path });

    const arr = Array.isArray(data) ? data : (data?.content || data?.data || data?.items || []);
    renderItems(arr);
    toast("ok","Canteen","تم تحميل العناصر");
  }catch(e){
    toast("err","Canteen فشل", e.message || String(e));
  }finally{
    setBusy(false);
  }
}
function renderItems(list){
  const root = $("#canteenList");
  root.innerHTML = "";
  if(!list || !list.length){
    const empty = el("div","hint");
    empty.textContent = "مفيش Items.";
    root.appendChild(empty);
    return;
  }

  list.forEach(x=>{
    const it = el("div","item");
    const meta = el("div","meta");
    const k = el("div","k"); k.textContent = (x.name || x.itemName || "Item") + (x.price ? " • " + x.price : "");
    const v = el("div","v"); v.textContent = "id: " + (pickId(x) ?? "-") + (x.category ? " | " + x.category : "");
    meta.appendChild(k); meta.appendChild(v);

    const act = el("div","actions");
    const bEdit = el("button","btn small"); bEdit.textContent="Edit";
    bEdit.onclick = ()=>showItemForm(x);

    const bDel = el("button","btn small danger"); bDel.textContent="Delete";
    bDel.onclick = ()=>deleteItem(x);

    act.appendChild(bEdit); act.appendChild(bDel);

    it.appendChild(meta); it.appendChild(act);
    root.appendChild(it);
  });
}
async function saveItem(){
  const name = $("#itemName").value.trim();
  const price = $("#itemPrice").value.trim();
  const qty = $("#itemQty").value.trim();
  const cat = $("#itemCat").value.trim();
  const desc = $("#itemDesc").value.trim();

  if(!name) return toast("warn","Item","Name مطلوب");
  if(price && isNaN(Number(price))) return toast("warn","Item","Price لازم رقم");

  setBusy(true);
  try{
    const editing = store.editing.item;
    const id = editing ? pickId(editing) : null;

    const body = {
      name, itemName:name,
      price: price ? Number(price) : undefined,
      cost: price ? Number(price) : undefined,
      description: desc, desc,
      category: cat || undefined,
      type: cat || undefined,
      quantity: qty ? Number(qty) : undefined,
      stock: qty ? Number(qty) : undefined,
    };

    // شيل undefined عشان بعض الباكات بتضايق
    Object.keys(body).forEach(k=> body[k]===undefined && delete body[k]);

    let r;
    if(id){
      r = store.routes.canteen.update;
      await request({ method:r.method, path:r.path, pathParams:{ id }, body });
      toast("ok","Item Updated","تم التعديل");
    }else{
      r = store.routes.canteen.create;
      await request({ method:r.method, path:r.path, body });
      toast("ok","Item Created","تم الإضافة");
    }

    hideItemForm();
    await loadCanteen();
  }catch(e){
    toast("err","Save Item فشل", e.message || String(e));
  }finally{
    setBusy(false);
  }
}
async function deleteItem(x){
  const id = pickId(x);
  if(id === null || id === undefined) return toast("warn","Delete","id مش موجود في العنصر");

  setBusy(true);
  try{
    const r = store.routes.canteen.delete;
    await request({ method:r.method, path:r.path, pathParams:{ id } });
    toast("ok","Deleted","تم الحذف");
    await loadCanteen();
  }catch(e){
    toast("err","Delete فشل", e.message || String(e));
  }finally{
    setBusy(false);
  }
}

/* =========================
   MODULES: ADMIN USERS
   ========================= */
function syncAdminButtons(){
  const ok = isAdmin();
  $("#btnNewStudent").disabled = !ok;
  $("#btnNewTeacher").disabled = !ok;
  $("#btnSaveUser").disabled = !ok;
}
function showUserForm(type, editObj){
  store.editing.user = editObj || null;
  $("#userForm").style.display = "block";
  $("#userType").value = type || editObj?.type || editObj?.role || "STUDENT";
  $("#userName").value = editObj?.name || editObj?.fullName || editObj?.username || "";
  $("#userEmail").value = editObj?.email || "";
  $("#userPassword").value = "";
  $("#userExternalId").value = editObj?.studentId || editObj?.staffId || editObj?.externalId || "";
  $("#userDept").value = editObj?.department || editObj?.dept || "";
}
function hideUserForm(){
  store.editing.user = null;
  $("#userForm").style.display = "none";
}
async function loadUsers(){
  setBusy(true);
  try{
    const r = store.routes.users.list;
    const data = await request({ method:r.method, path:r.path });
    const arr = Array.isArray(data) ? data : (data?.content || data?.data || data?.items || []);
    renderUsers(arr);
    toast("ok","Users","تم تحميل اليوزرز");
  }catch(e){
    toast("err","Users فشل", e.message || String(e));
  }finally{
    setBusy(false);
  }
}
function renderUsers(list){
  const root = $("#usersList");
  root.innerHTML = "";
  if(!list || !list.length){
    const empty = el("div","hint");
    empty.textContent = "مفيش Users.";
    root.appendChild(empty);
    return;
  }

  list.forEach(u=>{
    const it = el("div","item");
    const meta = el("div","meta");
    const k = el("div","k");
    k.textContent = (u.name || u.fullName || u.username || "User") + " • " + (u.role || u.type || "-");
    const v = el("div","v");
    v.textContent = (u.email ? u.email + " | " : "") + "id: " + (pickId(u) ?? "-");
    meta.appendChild(k); meta.appendChild(v);

    const act = el("div","actions");

    const bEdit = el("button","btn small");
    bEdit.textContent="Edit";
    bEdit.onclick = ()=>showUserForm((u.role||u.type||"STUDENT"), u);

    const bDel = el("button","btn small danger");
    bDel.textContent="Delete";
    bDel.onclick = ()=>deleteUser(u);

    act.appendChild(bEdit);
    act.appendChild(bDel);

    it.appendChild(meta);
    it.appendChild(act);
    root.appendChild(it);
  });
}
async function saveUser(){
  if(!isAdmin()) return toast("warn","Admin فقط","مش مسموح غير للأدمن");

  const type = $("#userType").value;
  const name = $("#userName").value.trim();
  const email = $("#userEmail").value.trim();
  const password = $("#userPassword").value;
  const externalId = $("#userExternalId").value.trim();
  const dept = $("#userDept").value.trim();

  if(!name) return toast("warn","User","Name مطلوب");
  if(!validateEmail(email)) return toast("warn","User","Email غلط");
  // باسورد: لو إنشاء جديد لازم. لو تعديل ممكن يفضل فاضي.
  const editing = store.editing.user;
  if(!editing && !validatePassword(password)) return toast("warn","User","Password لازم 8+");

  setBusy(true);
  try{
  const body = {
  name,
  fullName: name,
  username: name,
  email,
  role: type,
  type,
  department: dept || undefined,
  dept: dept || undefined,
  externalId: externalId || undefined
};

    if(password) body.password = password;

    Object.keys(body).forEach(k=> body[k]===undefined && delete body[k]);

    if(editing){
      const id = pickId(editing);
      const r = store.routes.users.update;
      await request({ method:r.method, path:r.path, pathParams:{ id }, body });
      toast("ok","User Updated","تم التعديل");
    }else{
      const r = (type==="STUDENT") ? store.routes.users.createStudent : store.routes.users.createTeacher;
      await request({ method:r.method, path:r.path, body });
      toast("ok","User Created","تم الإضافة");
    }

    hideUserForm();
    await loadUsers();
  }catch(e){
    toast("err","Save User فشل", e.message || String(e));
  }finally{
    setBusy(false);
  }
}
async function deleteUser(u){
  if(!isAdmin()) return toast("warn","Admin فقط","مش مسموح غير للأدمن");
  const id = pickId(u);
  if(id === null || id === undefined) return toast("warn","Delete","id مش موجود");

  setBusy(true);
  try{
    const r = store.routes.users.delete;
    await request({ method:r.method, path:r.path, pathParams:{ id } });
    toast("ok","Deleted","تم الحذف");
    await loadUsers();
  }catch(e){
    toast("err","Delete فشل", e.message || String(e));
  }finally{
    setBusy(false);
  }
}

/* =========================
   RAW API
   ========================= */
async function sendRaw(){
  const method = $("#rawMethod").value;
  const path = $("#rawPath").value.trim();
  const bodyText = $("#rawBody").value.trim();

  if(!path.startsWith("/")) return toast("warn","Raw","Path لازم يبدأ بـ /");

  let body = null;
  if(["POST","PUT","PATCH"].includes(method)){
    if(bodyText){
      body = safeJsonParse(bodyText);
      if(!body) return toast("warn","Raw","Body JSON غلط");
    }else{
      body = {};
    }
  }

  setBusy(true);
  try{
    const data = await request({ method, path, body });
    $("#rawResp").value = JSON.stringify(data, null, 2);
    toast("ok","Raw","OK");
  }catch(e){
    $("#rawResp").value = (e.payload && typeof e.payload!=="string") ? JSON.stringify(e.payload, null, 2) : (e.message || String(e));
    toast("err","Raw فشل", e.message || String(e));
  }finally{
    setBusy(false);
  }
}

/* =========================
   UI TABS
   ========================= */
function switchAuthTab(tab){
  [...document.querySelectorAll("#authTabs .tab")].forEach(x=>x.classList.toggle("active", x.dataset.tab===tab));
  $("#loginPane").style.display = tab==="login" ? "block" : "none";
  $("#registerPane").style.display = tab==="register" ? "block" : "none";
}
function switchMainTab(tab){
  [...document.querySelectorAll("#mainTabs .tab")].forEach(x=>x.classList.toggle("active", x.dataset.tab===tab));
  $("#paneCourses").style.display = tab==="courses" ? "block" : "none";
  $("#paneCanteen").style.display = tab==="canteen" ? "block" : "none";
  $("#paneAdmin").style.display = tab==="admin" ? "block" : "none";
  $("#paneRaw").style.display = tab==="raw" ? "block" : "none";
}

/* =========================
   HEALTH CHECK
   ========================= */
async function pingApi(){
  $("#kpiApi").textContent = "…";
  try{
    // محاولة بسيطة: GET على base (ممكن يدي html) أو على OpenAPI لو موجود
    if(store.openapiUrl){
      const r = await fetch(store.openapiUrl, { method:"GET" });
      if(r.ok){
        setStatus(true, "API: OK");
        $("#kpiApi").textContent = "OK";
        return true;
      }
    }
    const r2 = await fetch(store.baseUrl, { method:"GET" });
    if(r2.ok){
      setStatus(true, "API: OK");
      $("#kpiApi").textContent = "OK";
      return true;
    }
    setStatus(false, "API: ERR");
    $("#kpiApi").textContent = "ERR";
    return false;
  }catch{
    setStatus(false, "API: ERR");
    $("#kpiApi").textContent = "ERR";
    return false;
  }
}

/* =========================
   INIT
   ========================= */
async function init(){
  $("#baseUrl").value = store.baseUrl;
  saveSession();
  syncAdminButtons();

  // tabs wiring
  $("#authTabs").addEventListener("click", (e)=>{
    const t = e.target.closest(".tab");
    if(!t) return;
    switchAuthTab(t.dataset.tab);
  });
  $("#mainTabs").addEventListener("click", (e)=>{
    const t = e.target.closest(".tab");
    if(!t) return;
    switchMainTab(t.dataset.tab);
  });

  // buttons wiring
  $("#btnLogin").onclick = login;
  $("#btnRegister").onclick = register;
  $("#btnWhoAmI").onclick = ()=>whoami(false);
  $("#btnLogout").onclick = logout;

  $("#btnReDetect").onclick = async ()=>{
    setBusy(true);
    try{
      const ok = await detectOpenApi();
      if(ok){
        store.routes = buildRoutesFromOpenApi(store.openapi);
        toast("ok","OpenAPI","تم اكتشاف الـ API تلقائي");
      }else{
        store.routes = JSON.parse(JSON.stringify(FALLBACK));
        toast("warn","OpenAPI","مش متاح. شغال بـ Fallback Routes");
      }
      await pingApi();
    }finally{
      setBusy(false);
    }
  };

  $("#btnLoadCourses").onclick = loadCourses;
  $("#btnNewCourse").onclick = ()=>showCourseForm(null);
  $("#btnSaveCourse").onclick = saveCourse;
  $("#btnCancelCourse").onclick = hideCourseForm;

  $("#btnLoadCanteen").onclick = loadCanteen;
  $("#btnNewItem").onclick = ()=>showItemForm(null);
  $("#btnSaveItem").onclick = saveItem;
  $("#btnCancelItem").onclick = hideItemForm;

  $("#btnLoadUsers").onclick = loadUsers;
  $("#btnNewStudent").onclick = ()=>showUserForm("STUDENT", null);
  $("#btnNewTeacher").onclick = ()=>showUserForm("TEACHER", null);
  $("#btnSaveUser").onclick = saveUser;
  $("#btnCancelUser").onclick = hideUserForm;

  $("#btnSendRaw").onclick = sendRaw;

  // Detect OpenAPI on load
  setBusy(true);
  try{
    const ok = await detectOpenApi();
    if(ok){
      store.routes = buildRoutesFromOpenApi(store.openapi);
      toast("ok","API Ready","OpenAPI اتقري. Routing مضبوط");
    }else{
      store.routes = JSON.parse(JSON.stringify(FALLBACK));
      toast("warn","API Ready","OpenAPI مش متاح. Routing على Fallback");
    }

    await pingApi();

    // لو فيه token، حاول whoami silent
    if(store.token){
      await whoami(true);
      saveSession();
    }

    // خام: ادي مثال default في Raw
    $("#rawPath").value = store.routes.auth.me.path;
    $("#rawMethod").value = store.routes.auth.me.method;

  }finally{
    setBusy(false);
  }
}

init();
</script>
</body>
</html>


